---
- name: Install base packages
  become: true
  ansible.builtin.apt:
    name:
      - build-essential
      - ca-certificates
      - curl
      - fzf
      - git
      - gnupg
      - htop
      - lsb-release
      - openssh-client
      - tmux
      - tree
      - zsh
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Install zram generator
  become: true
  ansible.builtin.apt:
    name: systemd-zram-generator
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Configure zram generator
  become: true
  ansible.builtin.template:
    src: zram-generator.conf.j2
    dest: /etc/systemd/zram-generator.conf
    mode: '0644'

- name: Reload systemd for zram config
  become: true
  ansible.builtin.systemd_service:
    daemon_reload: true

- name: Ensure zram service is running
  become: true
  ansible.builtin.systemd_service:
    name: systemd-zram-setup@zram0.service
    enabled: true
    state: started

- name: Check Google Chrome apt source list
  become: true
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/google-chrome.list
  register: google_chrome_list

- name: Check Google Chrome deb822 source
  become: true
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/google-chrome.sources
  register: google_chrome_sources

- name: Force amd64 for Google Chrome repo when i386 is enabled
  become: true
  ansible.builtin.replace:
    path: /etc/apt/sources.list.d/google-chrome.list
    regexp: '^deb\\s+(?!\\[arch=)'
    replace: 'deb [arch=amd64] '
  when: google_chrome_list.stat.exists

- name: Force amd64 for Google Chrome deb822 repo when i386 is enabled
  become: true
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/google-chrome.sources
    regexp: '^Architectures:'
    line: 'Architectures: amd64'
    insertafter: '^Types:'
  when: google_chrome_sources.stat.exists
