---
- name: Read custom dconf file
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/roles/gnome/files/terminal-profiles.dconf"
  register: dconf_file

- name: Load terminal profiles
  ansible.builtin.command: dconf load /org/gnome/terminal/legacy/profiles:/
  args:
    stdin: "{{ dconf_file['content'] | b64decode }}"

- name: Extract UUIDs and visible names
  ansible.builtin.command: python3 {{ playbook_dir }}/roles/gnome/files/parse_dconf.py
  args:
    stdin: "{{ dconf_file['content'] | b64decode }}"
  register: parsed_dconf

- name: Resolve default profile UUID
  ansible.builtin.set_fact:
    gnome_profile_uuid: "{{ (parsed_dconf.stdout | from_json)[gnome.term.default_profile] }}"
  when: gnome.term.default_profile is defined

- name: Set default profile
  ansible.builtin.command: >
    dconf write /org/gnome/terminal/legacy/profiles:/default "'{{ gnome_profile_uuid }}'"
  when: gnome_profile_uuid is defined
