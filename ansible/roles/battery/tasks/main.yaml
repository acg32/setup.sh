---
- name: Remove legacy TLP PPA on Noble
  become: true
  ansible.builtin.apt_repository:
    repo: ppa:linrunner/tlp
    state: absent
  when: ansible_distribution_release == "noble"

- name: Remove legacy TLP deb822 source on Noble
  become: true
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/tlp.sources
    state: absent
  when: ansible_distribution_release == "noble"

- name: Install power tools (TLP path)
  become: true
  ansible.builtin.apt:
    name:
      - acpi
      - powertop
      - tlp
      - tlp-rdw
    state: present
    update_cache: true
    cache_valid_time: 3600
  when: not (battery.use_power_profiles_daemon | default(false) | bool)

- name: Enable TLP service
  become: true
  ansible.builtin.systemd_service:
    name: tlp
    enabled: true
    state: started
  when: not (battery.use_power_profiles_daemon | default(false) | bool)

- name: Install power-profiles-daemon
  become: true
  ansible.builtin.apt:
    name: power-profiles-daemon
    state: present
    update_cache: true
    cache_valid_time: 3600
  when: battery.use_power_profiles_daemon | default(false) | bool

- name: Enable power-profiles-daemon service
  become: true
  ansible.builtin.systemd_service:
    name: power-profiles-daemon
    enabled: true
    state: started
  when: battery.use_power_profiles_daemon | default(false) | bool

- name: Run Dell specific optimization
  ansible.builtin.include_tasks: dell.yaml
  when:
    - ansible_facts.chassis_vendor == "Dell Inc."
    - battery.enable_dell | default(false) | bool

- name: Disable Bluetooth in /etc/bluetooth/main.conf
  become: true
  ansible.builtin.lineinfile:
    path: /etc/bluetooth/main.conf
    regexp: '^AutoEnable=true'
    line: 'AutoEnable=false'
    state: present
    backup: true
  when: ansible_facts.os_family == "Debian"

# # Does not work yet, this is not valid after reboot
# # Does not work yet, this is not valid after reboot
# # Does not work yet, this is not valid after reboot
# # Does not work yet, this is not valid after reboot
# - name: Disable Docker network nic:docker0
#   become: true
#   ansible.builtin.command:
#     ifconfig docker0 down
